<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dark Hack 2.4</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.3/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #0d1117;
      font-family: 'Courier New', monospace;
      color: #fff;
      padding: 2rem;
    }
    .windows-box {
      background-color: #1e293b;
      padding: 1rem;
      margin-top: 2rem;
      border-radius: 0.75rem;
      box-shadow: 0 0 10px #3b82f6;
      max-height: 300px;
      overflow-y: auto;
    }
    .windows-entry {
      padding: 0.5rem;
      border-bottom: 1px solid #334155;
      font-size: 0.95rem;
    }
    .win { color: #22c55e; }
    .loss { color: #ef4444; }
    .highlight { font-weight: bold; }
  </style>
</head>
<body>
  <header class="text-center mb-6">
    <h1 class="text-4xl font-extrabold text-blue-500">Dark Hack</h1>
  </header>

  <!-- Updated Timer Box -->
  <div class="text-center text-2xl font-bold text-yellow-400 mb-4">
    <div class="timer-box">
      <div class="timer-text" id="timer">00:30</div>
    </div>
  </div>

  <div id="infoBox" class="bg-blue-900 border-2 border-blue-500 rounded-xl p-6 w-full max-w-md mx-auto shadow-lg font-bold text-lg leading-8 mb-4">
    Big/Small: <span id="bigSmall" class="text-red-500">--</span> <span id="bsPercent">(0%)</span><br />
    Red/Green: <span id="redGreen" class="text-red-500">--</span><br />
    Number: <span id="numbersBox"></span><br />
  </div>

  <div id="gameDataContainer" class="max-w-md mx-auto mb-6"></div>
  <div id="windowsBox" class="windows-box max-w-md mx-auto"></div>

  <script>
    const bigSmallEl = document.getElementById('bigSmall');
    const redGreenEl = document.getElementById('redGreen');
    const numbersBox = document.getElementById('numbersBox');
    const bsPercent = document.getElementById('bsPercent');
    const gameDataContainer = document.getElementById('gameDataContainer');
    const windowsBox = document.getElementById('windowsBox');

    function getFullNameAndShortForm(type, value) {
      if (type === 'bs') {
        if (value === 'BIG') return ['Big'];
        if (value === 'SMALL') return ['Small'];
        return ['Skip'];
      }
      if (type === 'color') {
        if (value === 'red') return ['Red'];
        if (value === 'green') return ['Green'];
        return ['Skip'];
      }
      return ['-'];
    }

    function detectCustomPattern(list) {
      if (list.length < 3) return null;
      const numbers = list.map(i => Number(i.number));
      const colors = list.map(i => i.colour.toLowerCase().split(',')[0]);
      const lastIndex = numbers.length - 1;
      const lastNum = numbers[lastIndex];
      const secondLastNum = numbers[lastIndex - 1];
      if (lastNum <= 4 && secondLastNum >= 5) {
        return { bigSmallPattern: 'BIG', confidenceBS: 100 };
      }
      if (lastNum <= 4) {
        const lastColor = colors[lastIndex];
        if (lastColor === 'green') return { topColor: 'red', confidenceColor: 100 };
        else if (lastColor === 'red') return { topColor: 'green', confidenceColor: 100 };
      }
      return null;
    }

    function analyze(dataList) {
      const numbers = dataList.map(d => Number(d.number));
      const freq = {};
      numbers.forEach(n => freq[n] = (freq[n] || 0) + 1);
      const sortedFreq = Object.entries(freq).sort((a,b) => b[1] - a[1]);
      const top3Numbers = sortedFreq.slice(0,3).map(e => e[0]);

      let bigCount = 0, smallCount = 0;
      numbers.forEach(n => n <= 4 ? smallCount++ : bigCount++);

      let bigSmallPattern = 'SKIP';
      if(bigCount > smallCount) bigSmallPattern = 'BIG';
      else if(smallCount > bigCount) bigSmallPattern = 'SMALL';

      const colorCount = { red: 0, green: 0 };
      dataList.forEach(item => {
        item.colour.toLowerCase().split(',').forEach(c => {
          if (c === 'red' || c === 'green') colorCount[c]++;
        });
      });

      let topColor = 'skip';
      if(colorCount.red > colorCount.green) topColor = 'red';
      else if(colorCount.green > colorCount.red) topColor = 'green';

      let confidenceBS = 70;
      const diff = Math.abs(bigCount - smallCount);
      if(diff >= 3) confidenceBS = 90;
      else if(diff === 2) confidenceBS = 82;
      else if(diff === 1) confidenceBS = 75;
      if(sortedFreq[0][1] >= 3) confidenceBS += 5;
      if(confidenceBS > 95) confidenceBS = 95;

      let confidenceColor = 70;
      const colorDiff = Math.abs(colorCount.red - colorCount.green);
      if(colorDiff >= 6) confidenceColor = 95;
      else if(colorDiff >= 4) confidenceColor = 88;
      else if(colorDiff >= 2) confidenceColor = 80;
      else if(colorDiff === 0) confidenceColor = 50;

      return { bigSmallPattern, topColor, top3Numbers, confidenceBS, confidenceColor };
    }

    function renderInfo(analysis) {
      const [bsFull] = getFullNameAndShortForm('bs', analysis.bigSmallPattern);
      const [colorFull] = getFullNameAndShortForm('color', analysis.topColor);

      bigSmallEl.textContent = `${bsFull}`;
      bsPercent.textContent = `(${analysis.confidenceBS}%)`;

      redGreenEl.textContent = `${colorFull} (${analysis.confidenceColor}%)`;
      redGreenEl.className = '';
      redGreenEl.classList.add(analysis.topColor === 'red' ? 'text-red-500' : 'text-green-400');

      numbersBox.innerHTML = '';
      (analysis.top3Numbers || []).forEach(num => {
        const span = document.createElement('span');
        span.textContent = num;
        span.className = 'inline-block bg-blue-600 px-2 py-1 rounded-lg text-lg font-extrabold mr-2';
        numbersBox.appendChild(span);
      });
    }

    function appendToWindows(issue, actualNumber, actualColor, pred) {
      const actualBS = actualNumber <= 4 ? 'SMALL' : 'BIG';
      const matchBS = pred.bigSmallPattern === actualBS;
      const matchColor = pred.topColor === actualColor;

      const periodShort = issue.toString().slice(-4);

      const line = document.createElement('div');
      line.innerHTML = `
        ${periodShort} | ${actualNumber} |${pred.bigSmallPattern}| 
        <span class="${matchBS ? 'win' : 'loss'}">${matchBS ? '✅' : '❌'}</span>
        |${pred.topColor.charAt(0).toUpperCase() + pred.topColor.slice(1)}| 
        <span class="${matchColor ? 'win' : 'loss'}">${matchColor ? '✅' : '❌'}</span> |
      `;
      windowsBox.prepend(line);
    }

    function renderTable(list) {
      gameDataContainer.innerHTML = '';
      const table = document.createElement('table');
      table.className = 'w-full text-sm text-center bg-gray-800';
      table.innerHTML = `
        <thead class="bg-blue-600 text-black">
          <tr><th>Issue</th><th>Number</th><th>Colour</th></tr>
        </thead>
        <tbody>
          ${list.map(item => `
            <tr class="hover:bg-gray-600">
              <td>${item.issueNumber}</td>
              <td>${item.number}</td>
              <td>${item.colour}</td>
            </tr>`).join('')}
        </tbody>`;
      gameDataContainer.appendChild(table);
    }

    async function fetchAndAnalyzeRepeatedly(repeats = 10) {
      let finalResult = null, bestList = [], maxConfidence = 0;

      // কনফিডেন্স ১০০% এবং ৯৫% গুলো গোনা হবে
      let count100 = 0;
      let count95 = 0;

      for (let i = 0; i < repeats; i++) {
        try {
          const res = await fetch('https://crbbb.com/api/webapi/GetNoaverageEmerdList', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json;charset=UTF-8' },
            body: JSON.stringify({
              pageSize: 10,
              pageNo: 1,
              typeId: 30,
              language: 0,
              random: "62d02162c2234c64b57aa4188c5810b2",
              signature: "9BF7A245709AA054E231D75C404C6527",
              timestamp: Math.floor(Date.now() / 1000)
            })
          });
          const data = await res.json();
          const list = data?.data?.list;
          if (!list) continue;

          const custom = detectCustomPattern(list);
          let result = analyze(list);
          if (custom) result = { ...result, ...custom };

          // কনফিডেন্সের মোট যোগফল
          let conf = result.confidenceBS + result.confidenceColor;

          // কনফিডেন্স ১০০% হলে কাউন্ট বাড়াও
          if(result.confidenceBS === 100 || result.confidenceColor === 100) count100++;
          else if(result.confidenceBS >= 95 || result.confidenceColor >= 95) count95++;

          // count100 বা count95 ৫ বা ৬ হলে ফাইনাল ১০০% দেখাও
          if(count100 >= 5 || count95 >= 6) {
            result.confidenceBS = 100;
            result.confidenceColor = 100;
            finalResult = result;
            bestList = list;
            break;
          }

          // অন্যথায় যেই maxConfidence সবচেয়ে বেশি
          if (conf > maxConfidence) {
            maxConfidence = conf;
            finalResult = result;
            bestList = list;
          }

          // ১০০ পার্সেন্ট হলে লুপ বন্ধ করো
          if (result.confidenceBS >= 100 || result.confidenceColor >= 100) break;

        } catch (err) { console.error("Fetch error", err); }
      }

      if (finalResult && bestList.length) {
        renderInfo(finalResult);
        renderTable(bestList);
        const marketLatest = bestList[0];
        const actualNumber = Number(marketLatest.number);
        const actualColor = marketLatest.colour.toLowerCase().split(',')[0];
        appendToWindows(marketLatest.issueNumber, actualNumber, actualColor, finalResult);
      }
    }

    // New Timer Code (Replacing startTimer)
    function updateTimer() {
      let now = new Date();
      let startHour = 5, startMinute = 30;
      let startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), startHour, startMinute, 0);
      let elapsedSeconds = Math.floor((now - startTime) / 1000);
      if (elapsedSeconds < 0) {
        startTime.setDate(startTime.getDate() - 1);
        elapsedSeconds = Math.floor((now - startTime) / 1000);
      }
      let remainingSeconds = 30 - (elapsedSeconds % 30);
      document.getElementById("timer").innerText = `00:${String(remainingSeconds).padStart(2, '0')}`;
      if (remainingSeconds === 30) {
        fetchAndAnalyzeRepeatedly();
      }
      setTimeout(updateTimer, 1000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateTimer();
      fetchAndAnalyzeRepeatedly();
    });
  </script>
</body>
</html>
